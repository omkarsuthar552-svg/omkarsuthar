<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Final Master Hand System: Earth, Universe & Maps</title>
    <style>
        body { margin: 0; overflow: hidden; background-color: #000; font-family: 'Segoe UI', sans-serif; }
        #webgl-container { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        #video-feed { position: absolute; bottom: 20px; right: 20px; width: 180px; z-index: 2; transform: scaleX(-1); border: 2px solid #ff9933; border-radius: 10px; opacity: 0.4; }
        #status-bar { position: absolute; top: 20px; left: 20px; color: #fff; z-index: 10; background: rgba(255,153,51,0.1); padding: 15px; border-left: 5px solid #ff9933; pointer-events: none; }
        #shape-display { font-size: 24px; font-weight: bold; color: #ff9933; text-transform: uppercase; letter-spacing: 2px; }
        .hint { font-size: 11px; color: #aaa; margin-top: 5px; }
    </style>
</head>
<body>
    <div id="status-bar">
        <div style="font-size: 12px; color: #ff9933;">SYSTEM ACTIVE</div>
        <div id="shape-display">India Tracking...</div>
        <div class="hint">3 Fingers: INDIA | 4 Fingers: RAJASTHAN</div>
        <div class="hint">5 Fingers: EARTH | Back-hand Fist: UNIVERSE</div>
    </div>
    <div id="webgl-container"></div>
    <video id="video-feed" autoplay></video>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>

    <script>
        let scene, camera, renderer, particles, geometry, material;
        let particleCount = 28000;
        let particlePositions = new Float32Array(particleCount * 3);
        let particleColors = new Float32Array(particleCount * 3);
        let videoElement, hands, lastHandPosition = null;
        let currentTemplate = 'india';

        function initThreeJS() {
            scene = new THREE.Scene();
            camera = new THREE.PerspectiveCamera(75, window.innerWidth / window.innerHeight, 0.1, 1000);
            renderer = new THREE.WebGLRenderer({ antialias: true });
            renderer.setSize(window.innerWidth, window.innerHeight);
            document.getElementById('webgl-container').appendChild(renderer.domElement);
            camera.position.z = 20;
            createParticles(currentTemplate);
            animate();
        }

        function createParticles(templateName) {
            document.getElementById('shape-display').innerText = templateName;
            if (particles) scene.remove(particles);
            geometry = new THREE.BufferGeometry();
            let color = new THREE.Color();

            for (let i = 0; i < particleCount; i++) {
                let x, y, z;
                
                if (templateName === 'india') {
                    // Optimized India Outline Logic
                    let lat = (Math.random() - 0.5) * 30; 
                    let lon = (Math.random() - 0.5) * 30;
                    // Formula to approximate India's triangular/diamond shape
                    if (lat < 15 && Math.abs(lon) < (lat + 15) * 0.6) {
                        x = lon * 0.8; y = lat * 0.8; z = (Math.random()-0.5);
                        // Tricolor Logic
                        if (y > 5) color.setHex(0xFF9933);      // Saffron
                        else if (y < -5) color.setHex(0x138808); // Green
                        else color.setHex(0xFFFFFF);             // White
                    } else { i--; continue; } // Re-run for density
                }
                else if (templateName === 'rajasthan') {
                    // Rajasthan Kite Shape Logic
                    let rx = (Math.random() - 0.5) * 15;
                    let ry = (Math.random() - 0.5) * 15;
                    // Approximation of Rajasthan's Rhombic shape
                    if (Math.abs(rx) + Math.abs(ry) < 8) {
                        x = rx; y = ry; z = (Math.random()-0.5);
                        color.setHex(0xFFCC00); // Desert Gold/Yellow
                    } else { i--; continue; }
                }
                else if (templateName === 'earth') {
                    let theta = Math.random() * Math.PI * 2;
                    let phi = Math.acos(Math.random() * 2 - 1);
                    let r = 8;
                    x = r * Math.sin(phi) * Math.cos(theta);
                    y = r * Math.sin(phi) * Math.sin(theta);
                    z = r * Math.cos(phi);
                    color.setHex(Math.random() > 0.6 ? 0x228B22 : 0x0000FF);
                } 
                else if (templateName === 'universe') {
                    let angle = Math.random() * Math.PI * 2;
                    let dist = Math.random() * 18;
                    x = Math.cos(angle + dist*0.4) * dist;
                    y = (Math.random() - 0.5) * 3;
                    z = Math.sin(angle + dist*0.4) * dist;
                    color.setHSL(0.6, 0.8, Math.random());
                }
                else {
                    let theta = Math.random() * Math.PI * 2;
                    x = Math.cos(theta) * 7; y = Math.sin(theta) * 7; z = (Math.random()-0.5)*5;
                    color.setHex(0xffffff);
                }

                particlePositions[i*3] = x; particlePositions[i*3+1] = y; particlePositions[i*3+2] = z;
                particleColors[i*3] = color.r; particleColors[i*3+1] = color.g; particleColors[i*3+2] = color.b;
            }

            geometry.setAttribute('position', new THREE.BufferAttribute(particlePositions, 3));
            geometry.setAttribute('color', new THREE.BufferAttribute(particleColors, 3));
            material = new THREE.PointsMaterial({ size: 0.08, vertexColors: true, blending: THREE.AdditiveBlending, transparent: true });
            particles = new THREE.Points(geometry, material);
            scene.add(particles);
        }

        function animate() {
            requestAnimationFrame(animate);
            if (particles) {
                particles.rotation.y += 0.005;
                if (lastHandPosition) {
                    particles.position.x = lastHandPosition.x * 12;
                    particles.position.y = lastHandPosition.y * 12;
                }
            }
            renderer.render(scene, camera);
        }

        async function setupHandTracking() {
            videoElement = document.getElementById('video-feed');
            hands = new Hands({ locateFile: (file) => `https://cdn.jsdelivr.net/npm/@mediapipe/hands/${file}` });
            hands.setOptions({ maxNumHands: 1, modelComplexity: 1, minDetectionConfidence: 0.7, minTrackingConfidence: 0.5 });
            hands.onResults(onResults);
            const cameraUtils = new Camera(videoElement, { onFrame: async () => await hands.send({image: videoElement}), width: 1280, height: 720 });
            cameraUtils.start();
        }

        function onResults(results) {
            if (results.multiHandLandmarks && results.multiHandLandmarks.length > 0) {
                const lm = results.multiHandLandmarks[0];
                lastHandPosition = { x: -(lm[0].x - 0.5), y: -(lm[0].y - 0.5), z: lm[0].z };
                
                const fingers = [lm[8].y < lm[6].y, lm[12].y < lm[10].y, lm[16].y < lm[14].y, lm[20].y < lm[18].y, lm[4].x < lm[2].x];
                let count = fingers.filter(Boolean).length;
                let isBackHand = lm[5].x < lm[17].x;

                let next = currentTemplate;
                if(!isBackHand) {
                    if(count === 3) next = 'india';
                    else if(count === 4) next = 'rajasthan';
                    else if(count === 5) next = 'earth';
                    else if(count === 1) next = 'sphere';
                } else {
                    if(count === 0) next = 'universe';
                }

                if (next !== currentTemplate) { currentTemplate = next; createParticles(currentTemplate); }
            } else { lastHandPosition = null; }
        }

        window.addEventListener('load', () => { initThreeJS(); setupHandTracking(); });
        window.addEventListener('resize', () => { renderer.setSize(window.innerWidth, window.innerHeight); camera.aspect = window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); });
    </script>
</body>
</html>